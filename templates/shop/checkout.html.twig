{% extends 'base.html.twig' %}

{% block title %}Validation de commande{% endblock %}

{% block stylesheets %}
    <style>
        :root {
            --ink:#0f172a;
            --accent:#ef4444;
            --muted:#6b7280;
            --card:#ffffff;
            --bg:linear-gradient(180deg,#f7f8fa 0%,#eef1f6 100%);
        }
        body { margin:0; font-family:"Helvetica Neue", Arial, sans-serif; background:var(--bg); color:var(--ink); position:relative; overflow-x:hidden; }
        body:before { content:''; position:fixed; inset:-20%; background:
            linear-gradient(160deg, rgba(15,23,42,0.85) 0%, rgba(15,23,42,0.35) 40%, rgba(239,68,68,0.4) 100%),
            url('https://rafaelalucas.com/dailyui/12/assets/img01.png') center/cover no-repeat;
            opacity:0.35; filter:blur(18px); z-index:-2; }
        body:after { content:''; position:fixed; inset:0; background:radial-gradient(circle at 70% 20%, rgba(239,68,68,0.12), transparent 35%), radial-gradient(circle at 20% 80%, rgba(14,165,233,0.12), transparent 30%); z-index:-1; }
        .page { max-width: 960px; margin: 0 auto; padding: 24px 16px 72px; }
        h1 { margin:0 0 8px 0; font-size:28px; }
        p.muted { margin:0 0 18px; color:#6b7280; }
        .links { display:flex; gap:12px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
        .links a { text-decoration:none; color:#1d4ed8; font-weight:600; }
        .stack { display:grid; gap:18px; }
        @media (min-width: 960px) { .stack { grid-template-columns: 1.2fr 1fr; } }
        .panel { background:var(--card); border:1px solid rgba(0,0,0,0.05); border-radius:16px; padding:18px; box-shadow:0 12px 30px rgba(0,0,0,0.04); position:relative; overflow:hidden; }
        .panel:before { content:''; position:absolute; inset:0; background:radial-gradient(circle at 20% 20%, rgba(239,68,68,0.05), transparent 30%); pointer-events:none; }
        .section-title { display:flex; align-items:center; gap:10px; margin-bottom:12px; }
        .badge { width:28px; height:28px; border-radius:9px; background:var(--ink); color:#fff; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:13px; }
        .muted { color:var(--muted); }
        label { font-weight:600; font-size:14px; display:block; margin-bottom:4px; }
        input, textarea { width:100%; padding:11px 12px; border-radius:12px; border:1px solid rgba(0,0,0,0.08); font-size:14px; background:#f8fafc; }
        input:focus, textarea:focus { outline:2px solid #bfdbfe; border-color:#93c5fd; background:#fff; }
        textarea { min-height:80px; }
        .form-grid { display:grid; gap:12px; }
        .two-cols { display:grid; gap:12px; grid-template-columns: repeat(2,1fr); }
        @media (max-width: 640px) { .two-cols { grid-template-columns: 1fr; } }
        .summary { display:grid; gap:12px; background:#0f172a; color:#fff; border-radius:14px; padding:14px; }
        .row { display:flex; justify-content:space-between; align-items:center; font-size:15px; }
        .total { font-weight:800; font-size:18px; }
        .cta { background:linear-gradient(120deg,#0f172a 0%, #1e293b 60%, #ef4444 120%); color:#fff; padding:14px 16px; border:none; border-radius:12px; font-weight:700; width:100%; cursor:pointer; transition:transform 120ms ease, box-shadow 120ms ease; }
        .cta:hover { transform:translateY(-1px); box-shadow:0 10px 24px rgba(15,23,42,0.18); }
        .info, .error { margin-top:12px; padding:12px 14px; border-radius:12px; font-size:14px; }
        .info { color:#166534; background:#ecfdf3; border:1px solid #bbf7d0; }
        .error { color:#b91c1c; background:#fee2e2; border:1px solid #fecdd3; }
        .cart-list { display:grid; gap:10px; }
        .cart-line { display:flex; justify-content:space-between; gap:12px; padding:12px; border:1px solid rgba(0,0,0,0.05); border-radius:12px; background:#f8fafc; transform:translateY(8px); opacity:0; transition:transform 240ms ease, opacity 240ms ease; }
        .cart-line.show { transform:translateY(0); opacity:1; }
        .cart-name { font-weight:700; }
        .cart-meta { display:flex; gap:8px; color:#475569; font-size:13px; }
        .empty { padding:12px; color:#6b7280; background:#f8fafc; border-radius:12px; border:1px dashed rgba(0,0,0,0.1); text-align:center; }
        @media (max-width: 720px) {
            .page { padding: 18px 14px 90px; }
            h1 { font-size:24px; }
            .panel { padding:14px; }
            .section-title { gap:8px; }
            .summary { position:sticky; bottom:12px; z-index:2; box-shadow:0 20px 30px rgba(0,0,0,0.12); }
            .cta { font-size:15px; }
        }
    </style>
{% endblock %}

{% block body %}
    <div class="page">
        <div class="links">
            <a href="{{ path('shop_cart') }}">← Retour panier</a>
            <a href="{{ path('shop_home') }}">Boutique</a>
        </div>
        <h1>Validation de commande</h1>
        <p class="muted">Un aperçu rapide de ton panier puis tes infos de livraison. Simple et clair.</p>

        <div class="stack">
            <div class="panel">
                <div class="section-title">
                    <span class="badge">1</span>
                    <div>
                        <div style="font-weight:700;">Ton panier</div>
                        <div class="muted">Dernier coup d'œil avant l'envoi</div>
                    </div>
                </div>
                <div id="cart-body" class="cart-list">
                    <div class="empty">Panier vide.</div>
                </div>
            </div>

            <div class="panel">
                <div class="section-title">
                    <span class="badge">2</span>
                    <div>
                        <div style="font-weight:700;">Contact & livraison</div>
                        <div class="muted">Tes coordonnées pour recevoir le colis</div>
                    </div>
                </div>
                <form id="checkout-form">
                    <div class="form-grid">
                        <div>
                            <label for="email">Email</label>
                            <input id="email" name="email" type="email" required placeholder="email@example.com">
                        </div>
                        <div>
                            <label for="name">Nom complet</label>
                            <input id="name" name="name" required placeholder="Prénom Nom">
                        </div>
                        <div>
                            <label for="address">Adresse</label>
                            <input id="address" name="address" required placeholder="12 rue des Lilas">
                        </div>
                        <div class="two-cols">
                            <div>
                                <label for="postal">Code postal</label>
                                <input id="postal" name="postal" required placeholder="75000">
                            </div>
                            <div>
                                <label for="city">Ville</label>
                                <input id="city" name="city" required placeholder="Paris">
                            </div>
                        </div>
                        <div>
                            <label for="note">Instruction (optionnel)</label>
                            <textarea id="note" name="note" placeholder="Digicode, étage, créneau..."></textarea>
                        </div>
                        <div class="summary">
                            <div class="row"><span>Sous-total</span><span id="subtotal">0 €</span></div>
                            <div class="row"><span>Livraison</span><span id="shipping">8 €</span></div>
                            <div class="row total"><span>Total</span><span id="total">0 €</span></div>
                        </div>
                        <button class="cta" type="submit">Simuler le paiement</button>
                        <div id="message" aria-live="polite"></div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        (function() {
            const body = document.getElementById('cart-body');
            const subtotalEl = document.getElementById('subtotal');
            const shippingEl = document.getElementById('shipping');
            const totalEl = document.getElementById('total');
            const message = document.getElementById('message');
            const form = document.getElementById('checkout-form');
            const defaultPrice = 39;
            const shipping = 8;
            const fmt = new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' });

            function loadCart() {
                try {
                    return JSON.parse(localStorage.getItem('cartItems') || '[]');
                } catch (e) {
                    return [];
                }
            }

            function renderCart() {
                const items = loadCart();
                if (!items.length) {
                    body.innerHTML = '<div class="empty">Panier vide.</div>';
                    subtotalEl.textContent = fmt.format(0);
                    shippingEl.textContent = fmt.format(shipping);
                    totalEl.textContent = fmt.format(shipping);
                    return { items, subtotal: 0 };
                }
                body.innerHTML = '';
                let subtotal = 0;
                items.forEach(item => {
                    const unit = item.price || defaultPrice;
                    const price = unit * (item.qty || 0);
                    subtotal += price;
                    const line = document.createElement('div');
                    line.className = 'cart-line';
                    line.innerHTML = `
                        <div>
                            <div class="cart-name">${item.name}</div>
                            <div class="cart-meta">Quantité : ${item.qty}</div>
                        </div>
                        <div style="text-align:right;">
                            <div class="cart-name">${fmt.format(price)}</div>
                            <div class="cart-meta">Unit. ${fmt.format(unit)}</div>
                        </div>
                    `;
                    body.appendChild(line);
                    requestAnimationFrame(() => line.classList.add('show'));
                });
                subtotalEl.textContent = fmt.format(subtotal);
                shippingEl.textContent = fmt.format(shipping);
                totalEl.textContent = fmt.format(subtotal + shipping);
                return { items, subtotal };
            }

            function showMessage(text, type) {
                message.innerHTML = '';
                if (!text) return;
                const div = document.createElement('div');
                div.className = type === 'error' ? 'error' : 'info';
                div.textContent = text;
                message.appendChild(div);
            }

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const { items, subtotal } = renderCart();
                if (!items.length) {
                    showMessage('Panier vide.', 'error');
                    return;
                }

                const itemsWithFallback = items.map(it => ({
                    ...it,
                    price: it.price || defaultPrice
                }));

                const payload = {
                    items: itemsWithFallback,
                    shipping,
                    contact: {
                        email: form.email.value,
                        name: form.name.value,
                        address: form.address.value,
                        postal: form.postal.value,
                        city: form.city.value,
                        note: form.note.value,
                    }
                };

                try {
                    const res = await fetch('{{ path('checkout_init') }}', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                    });
                    const data = await res.json();
                    if (!res.ok || data.error) {
                        throw new Error(data.error || 'Erreur lors de la préparation du paiement.');
                    }
                    showMessage(`Paiement simulé. Référence ${data.orderRef}, montant ${fmt.format(data.amount)}.`, 'info');
                    localStorage.removeItem('cartItems');
                } catch (err) {
                    showMessage(err.message || 'Erreur inconnue.', 'error');
                }
            });

            renderCart();
        })();
    </script>
{% endblock %}
